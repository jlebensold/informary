var table = 
[
  ['Date','Canon EOS Digital Rebel XTi ','Apple iPhone 5','Apple iPhone 3G ','Apple iPhone 4 ','Apple iPhone 4S ','Canon EOS Digital Rebel XT ','Apple iPhone ','Canon EOS Digital Rebel XSi ','Nikon D90','Canon EOS 5D Mark II ','Nikon D80 ','Canon EOS 40D','Canon EOS REBEL T1i','Canon EOS 7D','Apple iPhone 3G','Canon EOS REBEL T2i'],
  ['2009/01/13',5,0,0,0,0,4,1,0,0,0,3,2,0,0,0,0],
  ['2009/02/02',5,0,0,0,0,4,1,0,0,0,3,2,0,0,0,0],
  ['2009/08/27',5,0,0,0,0,0,4,3,0,0,2,1,0,0,0,0],
  ['2009/09/11',5,0,0,0,0,0,4,3,0,0,2,1,0,0,0,0],
  ['2009/11/11',5,0,0,0,0,0,4,3,0,0,2,1,0,0,0,0],
  ['2010/01/30',4,0,5,0,0,0,0,3,2,0,1,0,0,0,0,0],
  ['2010/02/08',4,0,5,0,0,0,0,3,2,0,1,0,0,0,0,0],
  ['2010/03/23',3,0,5,0,0,0,0,4,2,0,1,0,0,0,0,0],
  ['2010/05/23',3,0,5,0,0,0,0,4,2,0,1,0,0,0,0,0],
  ['2010/06/18',2,0,5,0,0,0,0,4,3,0,1,0,0,0,0,0],
  ['2010/07/29',2,0,5,0,0,0,0,4,3,1,0,0,0,0,0,0],
  ['2010/11/28',2,0,5,0,0,0,0,3,4,1,0,0,0,0,0,0],
  ['2011/01/30',0,0,5,0,0,0,0,3,4,2,0,0,1,0,0,0],
  ['2011/02/15',0,0,5,0,0,0,0,3,4,2,0,0,1,0,0,0],
  ['2011/04/01',0,0,0,1,0,0,0,4,5,2,0,0,0,0,3,0],
  ['2011/05/01',0,0,0,4,0,0,0,3,5,2,0,0,1,0,0,0],
  ['2011/06/02',0,0,0,4,0,0,0,2,5,3,0,0,1,0,0,0],
  ['2011/08/24',0,0,0,4,0,0,0,2,5,3,0,0,1,0,0,0],
  ['2011/09/03',0,0,0,5,0,0,0,0,4,3,0,0,1,0,0,2],
  ['2011/10/03',0,0,0,5,0,0,0,0,4,3,0,0,0,1,0,2],
  ['2011/11/03',0,0,0,5,0,0,0,0,4,3,0,0,0,1,0,2],
  ['2011/12/01',0,0,0,5,0,0,0,0,4,3,0,0,0,1,0,2],
  ['2012/01/01',0,0,0,5,0,0,0,0,4,3,0,0,0,1,0,2],
  ['2012/02/01',0,0,0,5,0,0,0,0,4,3,0,0,0,1,0,2],
  ['2012/03/01',0,0,0,5,0,0,0,0,3,4,0,0,0,1,0,2],
  ['2012/04/01',0,0,0,5,0,0,0,0,3,4,0,0,0,1,0,2],
  ['2012/05/03',0,0,0,5,0,0,0,0,3,4,0,0,0,1,0,2],
  ['2012/06/01',0,0,0,5,1,0,0,0,3,4,0,0,0,0,0,2],
  ['2012/07/01',0,0,0,5,3,0,0,0,1,4,0,0,0,0,0,2],
  ['2012/08/01',0,0,0,5,4,0,0,0,1,3,0,0,0,0,0,2],
  ['2012/09/01',0,0,0,5,4,0,0,0,1,3,0,0,0,0,0,2],
  ['2012/10/03',0,0,0,4,5,0,0,0,0,3,0,0,0,1,0,2],
  ['2012/11/01',0,0,0,4,5,0,0,0,0,3,0,0,0,1,0,2],
  ['2012/12/01',0,0,0,3,5,0,0,0,0,4,0,0,0,2,0,1],
  ['2013/01/02',0,0,0,4,5,0,0,0,0,3,0,0,0,2,0,1],
  ['2013/02/01',0,2,0,4,5,0,0,0,0,3,0,0,0,1,0,0],
  ['2013/03/01',0,3,0,4,5,0,0,0,0,2,0,0,0,1,0,0]
];

function getCameras(row) {
  return  _.map(row.slice(1), function(cell) {
    return { name: cell, brand: cell.split(' ')[0] }; 
  });
}

function getBucket(row) {
  return {
    date: row[0],
    i: getPopularities(row)
  };
}

function getPopularities(row) {
  row = row.slice(1);
  var a = _.filter(_.map(row,function(cell, i) { return { val: (cell == '5'), index: i }; }), function(o) {  return o.val;   })[0];
  var b = _.filter(_.map(row,function(cell, i) { return { val: (cell == '4'), index: i }; }), function(o) {  return o.val;   })[0];
  var c = _.filter(_.map(row,function(cell, i) { return { val: (cell == '3'), index: i }; }), function(o) {  return o.val;   })[0];
  var d = _.filter(_.map(row,function(cell, i) { return { val: (cell == '2'), index: i }; }), function(o) {  return o.val;   })[0];
  var e = _.filter(_.map(row,function(cell, i) { return { val: (cell == '1'), index: i }; }), function(o) {  return o.val;   })[0];
  return [
    [ a.index, 1000 ],
    [ b.index, 1000 ],
    [ c.index, 1000 ],
    [ d.index, 1000 ],
    [ e.index, 1000 ]
  ]
}

$(function() {
  var buckets = _.map(table.slice(1), function(row) { return getBucket(row); });
  process({buckets: buckets, cameras: getCameras(table[0]) });
});
